# Nabto client sdk for Android.

The sdk is primarily built using swig using a cpp wrapper on top of
the c library.

The library is split in two libraries such that the
`libnabto_client.so` can be extracted and used directly with ffi
bindings or other mechanisms instead of using the jni wrapper which is
inside the `libnabto_client_jni.so` library.

The swig code is generated by calling generate_swig.sh from CMake, CMake is called from jni/build.gradle.

## Release strategy

All non tagged builds are put into the snapshot repository at  https://s01.oss.sonatype.org/content/repositories/snapshots/com/nabto/edge/client/library/ using a naming strategy which is "<branch-name>-SNAPSHOT".

All tagged releases are going to the staging repository where they need to be accepted before they can go to the maven central repository.

## Building the library

Run `./gradlew build`

## Publishing the library to the local maven repository

run `./gradlew publishToMavenLocal`

## Publish to maven OSSRH.

This requires OSSRH_USERNAME, OSSRH_PASSWORD, GPG_SIGNING_PASSWORD and GPG_SIGNING_KEY_BASE64 to be set. These variables can be set in ~/.gradle/gradle.properties for local builds or via the environment for CI builds. ORG_GRADLE_PROJECT_OSSRH_USERNAME etc. Credentials can be found in dokuwiki.

The base64 key can be created by `gpg --armor --export-secret-keys keyid | base64 -w 0`

`./gradlew publish`

Tagged releases will be sent to the staging repository at sonatype https://s01.oss.sonatype.org/ Where they manually needs to be promoted as releases before they can be found in maven central.

Non release builds aka snapshots can be found at https://s01.oss.sonatype.org/content/repositories/snapshots/com/nabto/edge/client/library/

## Running a single test case

```
./gradlew :library:connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.nabto.edge.client.TunnelTest#connect
```

## Debugging swig generation

`swig -c++ -java -debug-tmsearch nabto_client.i`, it can also be
appropriate to make a minimum reproduction and get the swig right in a
limited example.

## Working with android stack traces

```
./Android/Sdk/platform-tools/adb logcat > out.txt
./Android/Sdk/ndk-bundle/ndk-stack -sym sandbox/nabto-client-sdk/android-client/jni/build/intermediates/merged_native_libs/debug/out/lib/arm64-v8a/ -dump out.txt
```

## Open a remote pairing fragment

```
adb shell am start -W -a android.intent.action.VIEW -d 'heatpump://app/remote_pair_device?product_id=pr-bqyh43fb\&device_id=de-hkpcwynp\&server_key=sk-9d3028f1f3de68f0844ea544a42a4f05\&server_url=https://a.clients.dev.nabto.com' com.nabto.edge.heatpump
```


# QA needed for a library

## Lifecycle tests

The idea with these tests is that they should test app lifecycle events.

### Test Life 1.

An app should be able to handle activity lifecycle events described here:
https://developer.android.com/guide/components/activities/activity-lifecycle

  1. The app should be able to start and then be stopped.
  2. The app should be able to be paused and then resumed.
  3. The app should be able to be killed and then created.
  4. The app should be able to stopped and then restarted.



## Features

These test features of the client sdk

### Test Feature 1.

The app must be able to make a tunnel and it should be shown that a resource can be reached through the tunnel.

Scope: connectedAndroidTest

```
./gradlew :library:connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.nabto.edge.client.TunnelTest#connect
```

### Test Feature 2.

The app must be able to get logs from the nabto-client-sdk.

Scope: connectedAndroidTest



### Test Feature 4.

The app must be able to make a stream.

Scope: connectedAndroidTest

```
./gradlew :library:connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.nabto.edge.client.StreamTest
```

### Test Feature 5.

The app must be able to make a coap request.

Scope: connectedAndroidTest

```
./gradlew :library:connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.nabto.edge.client.CoapTest
```

### Test Feature 6.

The app must be able to get the version of the nabto core library.
The app must be able to get the version of the nabto wrapper library.

./gradlew :library:connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.nabto.edge.client.ClientTest#nabtoVersion


## Connectivity

Test connectivity from an app with the nabto-client-sdk.


### Test Conn 1.

The app must be able to connect to a remote nabto-device.

Scope: connectedAndroidTest



### Test Conn 3.

The app must be able to connect to a local nabto-device on an ipv4 only local network.

Scope: connectedAndroidTest on a real device with given network

Make sure the test device and phone is on the same network.

run a test device: `./start_local_test_device.sh`

./gradlew :library:connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.nabto.edge.client.ConnectionTest#connectLocal

### Test Conn 4.

The app must be able to connect to a local nabto-device on an ipv6 only local network.

Scope: connectedAndroidTest on a real device with given network

join ipv6only network on both laptop and phone. Currently our embedded sdk test
devices has a problem with ipv6 and mdns so this probably fails.


### Test Conn 5.

On android, if there is not internet access on a local network, then
by default no traffic is sent to that network.

The app must be able to connect to a local nabto-device on a network without internet access on a android-device which has internet access via 3/4/5g

Scope: connectedAndroidTest on a real device with given network

prerequisite: embedded sdk device and android joins an ipv4 network without internet access

run a test device: `./start_local_test_device.sh`

This is TODO since gradle does not seem to function without internet.

./gradlew :library:connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.nabto.edge.client.ConnectionTest#connectLocal


### Test Conn 6.

The client can scan for mdns devices, subtypes and get txt records.

`./start_local_test_device.sh`

./gradlew :library:connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.nabto.edge.client.MdnsTest

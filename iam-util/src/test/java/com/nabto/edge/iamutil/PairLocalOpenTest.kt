package com.nabto.edge.iamutil

import com.nabto.edge.client.Connection
import com.nabto.edge.iamutil.mocks.createCoapErrorMock
import com.nabto.edge.iamutil.mocks.createGetPairingCoapMock
import com.nabto.edge.iamutil.mocks.createPutUserUsernameCoapMock
import com.nabto.edge.iamutil.mocks.pairingLocalOpenCoapMock
import io.mockk.every
import io.mockk.mockk
import org.junit.Assert.assertEquals
import org.junit.Before
import org.junit.Test
import kotlin.test.assertFailsWith

@kotlinx.serialization.ExperimentalSerializationApi
class PairLocalOpenTest {
    val connection : Connection = mockk<Connection>();
    val iamUtil = IamUtil.create()
    val username = "testuser"

    @Before
    fun setup() {
        every { connection.createCoap("GET", "/iam/pairing" ) } returns ( createGetPairingCoapMock() )
    }

    @Test
    fun pairLocalOpen() {
        every { connection.createCoap("POST", "/iam/pairing/local-open" ) } returns ( pairingLocalOpenCoapMock(username, 201) )
        iamUtil.pairLocalOpen(connection, username);
    }

    @Test
    fun pairLocalOpenBadRequest() {
        every { connection.createCoap("POST", "/iam/pairing/local-open" ) } returns ( pairingLocalOpenCoapMock(username, 400) )
        val exception = assertFailsWith<IamException> {
            iamUtil.pairLocalOpen(connection, username);
        }
        assertEquals(exception.getError(), IamError.INVALID_INPUT)
    }
    @Test
    fun pairLocalOpenBlockedByIam() {
        every { connection.createCoap("POST", "/iam/pairing/local-open" ) } returns ( pairingLocalOpenCoapMock(username, 403) )
        val exception = assertFailsWith<IamException> {
            iamUtil.pairLocalOpen(connection, username);
        }
        assertEquals(exception.getError(), IamError.BLOCKED_BY_DEVICE_CONFIGURATION)
    }
    @Test
    fun pairLocalOpenModeDisabled() {
        every { connection.createCoap("POST", "/iam/pairing/local-open" ) } returns ( pairingLocalOpenCoapMock(username, 404) )
        val exception = assertFailsWith<IamException> {
            iamUtil.pairLocalOpen(connection, username);
        }
        assertEquals(exception.getError(), IamError.PAIRING_MODE_DISABLED)
    }
    @Test
    fun pairLocalOpenUsernameExists() {
        every { connection.createCoap("POST", "/iam/pairing/local-open" ) } returns ( pairingLocalOpenCoapMock(username, 409) )
        val exception = assertFailsWith<IamException> {
            iamUtil.pairLocalOpen(connection, username);
        }
        assertEquals(exception.getError(), IamError.USERNAME_EXISTS)
    }
}
